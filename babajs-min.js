var BabaJS={_stack:{},generateHTML:function(a,b){this._stack={};if(typeof a==="string"){var c=this._compile(a);return this._replaceCompiledTags(c.chtml,c.ctags,b)}if(!a.ready)if(c=this._templates[a.templateName]){if(!c.compiled)c.compiled=this._compile(c.raw),delete c.raw;return this._replaceCompiledTags(c.compiled.chtml,c.compiled.ctags,b)}else throw Error(a.templateName+" was not found in template manager");this._asynchGenerateHTML(a,b)},_cfg:{fetcher:null,URLConvertor:null,context:window},setConfig:function(a){if(a.URLConvertor)this._cfg.URLConvertor= a.URLConvertor;if(a.fetcher)this._cfg.fetcher=a.fetcher;if(a.context)this._cfg.context=a.context;if(a.dep)this._dep=a.dep;if(a.flagCb)this._cfg.flagCb=a.flagCb},_dep:{},includeTemplate:function(a,b){var c=this._templates[a];if(c){if(!c.compiled)c.compiled=this._compile(c.raw),delete c.raw;return this._replaceCompiledTags(c.compiled.chtml,c.compiled.ctags,b)}throw Error(a+" was not found in template manager");},removeTemplate:function(a){delete this._templates[a]},_getMissingTemplates:function(a){for(var b= [],c=0;c<a.length;c++)this._templates[a[c]]||b.push(a[c]);return b},_fetchTemplate:function(a,b,c,e,d){var f=a.fetcher?a.fetcher:this._cfg.fetcher,a=a.context?a.context:this._cfg.context;if(f){var g=this;f.call(a,b,function(a){g._templates[b]={compiled:g._compile(a)};e.call(d,true)})}else this._ajax(c,function(a){a!==false?(this._templates[b]={compiled:this._compile(a)},e.call(d,true)):e.call(d,false)},this)},_ajax:function(a,b,c){var e;e=window.ActiveXObject?new window.ActiveXObject("Microsoft.XMLHTTP"): new window.XMLHttpRequest;e.open("GET",a);e.onreadystatechange=function(){e.readyState==4&&(e.status==200||e.status==0?b.call(c,e.responseText):b.call(c,false))};e.send()},ensureLocal:function(a,b,c,e){this._ensureLocal({URLConvertor:this._cfg.URLConvertor,fetcher:this._cfg.fetcher,context:this._cfg.context},a,b,c,function(a){e.call(this._cfg.context,a)},this)},_ensureLocal:function(a,b,c,e,d,f){var c=c?c:[],e=e?e:[],g=0,k=a.URLConvertor?a.URLConvertor:this._cfg.URLConvertor,l=a.context?a.context: this._cfg.context,h=b.length+e.length+c.length;h==0&&d.call(f,true);for(var j=0;j<b.length;j++){var p=k?k.call(l,b[j]):"";this._fetchTemplate(a,b[j],p,function(a){if(a===false)throw Error("Failed to fetch template"+p);g++;g==h&&d.call(f,true)},this)}for(j=0;j<c.length;j++)this._fetchJS(c[j],function(){g++;g==h&&d.call(f,true)},this);for(j=0;j<e.length;j++)this._fetchCSS(e[j],function(){g++;g==h&&d.call(f,true)},this)},_fetchJS:function(a,b,c){this._js[a]?b.call(c,true):this._ajax(a,function(e){if(e=== false)b.call(c,false);else{var d=document.createElement("script");d.type="text/javascript";this._isIE()?d.text=e:d.innerHTML=e;document.getElementsByTagName("head")[0].appendChild(d);this._js[a]=true;b.call(c,true)}},this)},_ie:null,_isIE:function(){if(this._ie===null)this._ie=navigator.userAgent.indexOf("MSIE")!=-1?true:false;return this._ie},_fetchCSS:function(a,b,c){this._css[a]?b.call(c,true):this._ajax(a,function(e){if(e===false)b.call(c,false);else{var d=document.createElement("style");d.type= "text/css";this._isIE()?d.styleSheet.cssText=e:d.innerHTML=e;document.getElementsByTagName("head")[0].appendChild(d);this._css[a]=true;b.call(c,true)}},this)},_getDependencies:function(a,b,c){b=b?b:{templates:[],js:[],css:[]};c=c?c:{};if(c[a])return b;if(!this._dep[a])return b;c[a]=true;if(this._dep[a].templates){b.templates=this._uniqueAdd(b.templates,this._dep[a].templates);for(var e=0;e<this._dep[a].templates.length;e++)this._getDependencies(this._dep[a].templates[e],b,c)}if(this._dep[a].js)b.js= this._uniqueAdd(b.js,this._dep[a].js);if(this._dep[a].css)b.css=this._uniqueAdd(b.css,this._dep[a].css);return b},_uniqueAdd:function(a,b){for(var c=[],e={},d=0;d<a.length;d++)c.push(a[d]),e[a[d]]=true;for(d=0;d<b.length;d++)e[b[d]]||c.push(b[d]);return c},_asynchGenerateHTML:function(a,b){var c=a.context?a.context:this._cfg.context,e=[a.templateName];a.requires&&a.requires instanceof Array&&(e=e.concat(a.requires));a.requires&&a.requires.templates&&(e=e.concat(a.requires.templates));var d=this._getMissingTemplates(e), f=[];if(a.requires&&a.requires.js)f=a.requires.js;var g=[];if(a.requires&&a.requires.css)g=a.requires.css;var k=this._getDependencies(a.templateName),l={};l[a.templateName]=true;for(var h=0;h<e.length;h++)this._getDependencies(e[h],k,l);d=this._uniqueAdd(d,k.templates);f=this._uniqueAdd(f,k.js);g=this._uniqueAdd(g,k.css);this._ensureLocal(a,d,f,g,function(){var d=this._templates[a.templateName];if(!d.compiled)d.compiled=this._compile(d.raw),delete d.raw;d=this._replaceCompiledTags(d.compiled.chtml, d.compiled.ctags,b);a.ready&&a.ready.call(c,d,a.templateName)},this)},_templates:{},_css:{},_js:{},addTemplates:function(a){for(var b in a){var c=this._compile(a[b]);this._templates[b]={compiled:c}}},addTemplate:function(a,b){if(!this._templates[a]){var c=this._compile(b);this._templates[a]={compiled:c}}},_replaceCompiledTags:function(a,b,c){var e=/_{([\d]+)}_/g,d=/_{[\d]+}_/,f;for(e.lastIndex=0;f=e.exec(a);)a=a.replace(d,this._evalCtag(b,f[1],c)),e.lastIndex=0;return a},_evalCtag:function(a,b,c){b= a[b];switch(b.type){case "code":return this._evalCodeTag(c,b);case "assign":return this._evalCodeTag(c,b,true);case "if":return this._evalConditionTag(c,a,b);case "loop":return this._evalLoopTag(c,a,b);default:return"Unknown tag"}},_evalLoopTag:function(a,b,c){var e="",d="",f="",g;for(g in this._stack)e+="var "+g+"="+this._stringify(this._stack[g])+";\r\n";f="";for(g in this._stack)f+="this._stack['"+g+"'] = "+g+";\r\n";for(g=0;g<c.vars.length;g++)f+="this._stack['"+c.vars[g]+"'] = "+c.vars[g]+";\r\n"; g="var _retVal = '';\r\n"+c.code+"{\r\n\t "+f+"\r\n _retVal += this._replaceCompiledTags('"+c.chtml1.replace(/[\r\n]/g,"")+"',ctags,data);} return _retVal;";try{d=(new Function("data","ctags","try{"+e+g+"}catch(_err){return _err;}finally{"+f+"}")).call(this,a,b),typeof d=="string"&&(d=d.replace(/[\$]/g,"&#36;"))}catch(k){throw this._log("ERROR: ",k," Fn=_evalLoopTag ctag=",c," data=",a),k;}return d},_log:function(){window.console&&console.log.apply(console,arguments)},_evalConditionTag:function(a, b,c){var e="",d="",f;for(f in this._stack)e+="var "+f+"="+this._stringify(this._stack[f])+";\r\n";var g="";for(f in this._stack)g+="this._stack['"+f+"'] = "+f+";\r\n";for(f=0;f<c.vars.length;f++)g+="this._stack['"+c.vars[f]+"'] = "+c.vars[f]+";\r\n";e="try{"+e+("return ("+c.code+");")+"}catch(_err){return _err;}finally{"+g+"}";try{return(d=(new Function("data",e)).call(this,a))?this._replaceCompiledTags(c.chtml1,b,a):this._replaceCompiledTags(c.chtml2,b,a)}catch(k){throw this._log("ERROR: ",k," Fn=_evalConditionTag ctag=", c," data=",a),k;}},_evalCodeTag:function(a,b,c){var e="",d="",f;for(f in this._stack)e+="var "+f+"="+this._stringify(this._stack[f])+";\r\n";var g="";for(f in this._stack)g+="this._stack['"+f+"'] = "+f+";\r\n";for(f=0;f<b.vars.length;f++)g+="this._stack['"+b.vars[f]+"'] = "+b.vars[f]+";\r\n";c="try{"+e+((c===true?"return ":"")+b.code+(c===true?";":""))+"}catch(_err){return _err;}finally{"+g+" }";try{d=(new Function("data",c)).call(this,a);typeof d==="undefined"&&(d="");if(d instanceof Error)return this._log("BabaJS Error: ", d.message,d.href,d.lineNo,d.source),d.message;typeof d=="string"&&(d=d.replace(/[\$]/g,"&#36;"))}catch(k){throw this._log("ERROR: ",k," Fn=_evalCodeTag ctag=",b," data=",a),k;}b.flags.length&&(this._cfg.flagCb?(a=this._cfg.flagCb.call(this._cfg.context,d,b.flags),d=typeof a=="string"?a:this._processPredefinedFlags(b.flags,d)):d=this._processPredefinedFlags(b.flags,d));return d},_processPredefinedFlags:function(a,b){return a[0]=="s"?this._secureText(b,"low"):a[0]=="S"?this._secureText(b,"high"):b}, secureText:function(a,b){return this._secureText(a,typeof b=="undefined"?"low":b)},_secureText:function(a,b){if(!a)return a;var c=this;return a.replace({low:/[\<\>\"\']/g,high:/[\<\>\&\"\'\`\,\!\@\$\%\(\)\[\]\{\}\=\+]/g}[b],function(a){return c._escaped[a]})},_escaped:{"'":"&lsquo;","<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","`":"&#96;",",":"&#44;","!":"&#33;","@":"&#64;",$:"&#36;","(":"&#40;",")":"&#41;","[":"&#91;","]":"&#93;","{":"&#123;","}":"&#125;","=":"&#61;","+":"&#61;"},_stringify:function(a){if(window.JSON)return JSON.stringify(a); if(typeof a=="string"||typeof a=="number"||typeof a=="boolean")return a.toString();throw Error("Can't stringify an Object or an Array without JSON Support. please include a JSON object to the window object. Try https://github.com/douglascrockford/JSON-js");},_compile:function(a){for(var b=[],c=0,e={chtml:"",ctags:{}},d,f="",g=null,k="chtml",l=null,h="html",j=0,p=a.length;j<p;j++)if(d=a.charAt(j),d=="<"&&j<p-1&&a.charAt(j+1)=="%"){var n=this._getCtagType(a,j+2),l=n;if(n=="code"||n=="assign"||n=="if"|| n=="loop"){if(b.length>0)e.ctags[b[b.length-1]]._state=h;var o=this._getNewCtag(n);b.push(c);e.ctags[c]=o;this._addToCurrent(k,h,e,"_{"+c+"}_");k=c;c++}h="tag"}else if(h=="flag")if(d!=","&&d!=" "&&d!='"'&&d!="'"&&d!=")")f+=d,d=="."&&g=="number"?g="float":d>="0"&&d<="9"&&g!=="string"&&g!=="float"&&(g="number");else if(d==","||d==" ")f.length&&(d=f,g=="number"&&(d=parseInt(f)),g=="float"&&(d=parseFloat(f)),o.flags.push(d)),f="",g=null;else{if(d==")"&&(f.length&&(d=f,g=="number"&&(d=parseInt(f)),g== "float"&&(d=parseFloat(f)),o.flags.push(d)),f="",g=null,a.charAt(j+1)==" "||a.charAt(j+1)=="=")){h="code";if(a.charAt(j+1)=="=")n=o.type="assign";j++}}else if(h=="tag")if((n=="code"||n=="assign")&&d=="%"&&a.charAt(j+1)=="f")h="flag",j+=2,f="",g=null;else if(n=="code"&&d=="%"&&a.charAt(j+1).toLowerCase()!="s"&&a.charAt(j+1)!="f")h="code";else if(n=="assign"&&d=="=")h="code";else if(d==" ")h="code";else{if(d=="%"&&j<p-1&&a.charAt(j+1)==">")l=="else"?h="chtml2":(b.pop(),b.length==0?(l=null,k="chtml", h="html"):(h=e.ctags[b[b.length-1]],l=h.type,k=b[b.length-1],h=h._state)),j++}else if(d=="%"&&j<p-1&&a.charAt(j+1)==">"){if(l=="code"||l=="assign")b.pop(),b.length==0?(l=null,k="chtml",h="html"):(h=e.ctags[b[b.length-1]],l=h.type,k=b[b.length-1],h=h._state);else if(l=="if"||l=="loop")h="chtml1";j++}else h!="tag"&&this._addToCurrent(k,h,e,d);this._findVars(e);return e},_findVars:function(a){for(var b in a.ctags)a.ctags[b].vars=this._findVar(a.ctags[b].code)},_isWhiteSpace:function(a){return/[\s]/.test(a)}, _findVar:function(a){for(var b=[],c=false,e="",d=0,f=0,g=0,k=0,l=0,h=false,j=false,p=0,n=0,o=false,q=false,i=0,r=a.length;i<r;i++){var m=a.charAt(i);if(m=="("){if(d++,!h&&i>=8&&a.charAt(i-1)=="n"&&a.charAt(i-2)=="o"&&a.charAt(i-3)=="i"&&a.charAt(i-4)=="t"&&a.charAt(i-5)=="c"&&a.charAt(i-6)=="n"&&a.charAt(i-7)=="u"&&a.charAt(i-8)=="f"&&(h=true),!q&&!h&&!o&&(i>=3&&a.charAt(i-1)=="r"&&a.charAt(i-2)=="o"&&a.charAt(i-3)=="f"||i>=5&&a.charAt(i-1)=="e"&&a.charAt(i-2)=="l"&&a.charAt(i-3)=="i"&&a.charAt(i- 4)=="h"&&a.charAt(i-5)=="w"))q=true}else if(m==")")d--,d==0&&!h&&!j&&q&&(q=false),h&&f==0&&d==0&&(h=false);else if(m=="{")f++,o&&g++;else if(m=="[")l++,o&&k++;else if(m=="]")l--,o&&k--;else if(m=="}")f--,o&&g--,h&&f==0&&d==0&&(h=false);else if(m=='"')p=p?0:1;else if(m=="'")n=n?0:1;else if(m=="="&&!h&&c&&!j){o=true;e&&(b.push(e),e="");continue}j=n||p?true:false;if(!h&&!j&&(q||!d))if(!c&&m=="v"){if(i==0&&i<r-4&&a.charAt(i+1)=="a"&&a.charAt(i+2)=="r"&&this._isWhiteSpace(a.charAt(i+3))||(this._isWhiteSpace(a.charAt(i- 1))||a.charAt(i-1)=="{"||a.charAt(i-1)=="(")&&i<r-4&&a.charAt(i+1)=="a"&&a.charAt(i+2)=="r"&&this._isWhiteSpace(a.charAt(i+3)))c=true,i+=3}else c&&(m==","&&g==0&&k==0?(e&&(b.push(e),e=""),o=false):m==" "&&q?(e&&(b.push(e),e=""),i<r-3&&a.charAt(i+1)=="i"&&a.charAt(i+2)=="n"&&a.charAt(i+3)==" "&&(o=c=false)):m==";"?(e&&(b.push(e),e=""),o=c=false):m=="i"&&i<r-3&&a.charAt(i+1)=="n"&&this._isWhiteSpace(a.charAt(i+2))?(e&&(b.push(e),e=""),c=false):!this._isWhiteSpace(m)&&!o&&(e+=m))}return b},_addToCurrent:function(a, b,c,e){a=="chtml"?c.chtml+=e:c.ctags[a][b]+=e},_getCtagType:function(a,b){if(a.charAt(b)=="=")return"assign";if(a.charAt(b).toUpperCase()=="I")return"if";if(a.charAt(b).toUpperCase()=="L")return"loop";if(a.charAt(b).toUpperCase()=="E"&&b<a.length-2){if(a.charAt(b+1).toUpperCase()=="L")return"else";if(a.charAt(b+1).toUpperCase()=="N"&&b<a.length-4){if(a.charAt(b+3).toUpperCase()=="I")return"endif";if(a.charAt(b+3).toUpperCase()=="L")return"endloop"}}return"code"},_getNewCtag:function(a){return{type:a, code:"",chtml1:"",chtml2:"",vars:[],flags:[]}}};