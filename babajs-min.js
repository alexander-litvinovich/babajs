var BabaJS={_stack:{},generateHTML:function(a,b){this._stack={};if(typeof a==="string"){var c=this._compile(a);return this._replaceCompiledTags(c.chtml,c.ctags,b)}if(!a.ready)if(c=this._templates[a.templateName]){if(!c.compiled)c.compiled=this._compile(c.raw),delete c.raw;return this._replaceCompiledTags(c.compiled.chtml,c.compiled.ctags,b)}else throw Error(a.templateName+" was not found in template manager");this._asynchGenerateHTML(a,b)},_cfg:{fetcher:null,URLConvertor:null,context:window},setConfig:function(a){if(a.URLConvertor)this._cfg.URLConvertor= a.URLConvertor;if(a.fetcher)this._cfg.fetcher=a.fetcher;if(a.context)this._cfg.context=a.context;if(a.dep)this._dep=a.dep},_dep:{},includeTemplate:function(a,b){var c=this._templates[a];if(c){if(!c.compiled)c.compiled=this._compile(c.raw),delete c.raw;return this._replaceCompiledTags(c.compiled.chtml,c.compiled.ctags,b)}throw Error(a+" was not found in template manager");},removeTemplate:function(a){delete this._templates[a]},_getMissingTemplates:function(a){for(var b=[],c=0;c<a.length;c++)this._templates[a[c]]|| b.push(a[c]);return b},_fetchTemplate:function(a,b,c,d,e){var f=a.fetcher?a.fetcher:this._cfg.fetcher,a=a.context?a.context:this._cfg.context;if(f){var g=this;f.call(a,b,function(a){g._templates[b]={compiled:g._compile(a)};d.call(e,!0)})}else this._ajax(c,function(a){a!==!1?(this._templates[b]={compiled:this._compile(a)},d.call(e,!0)):d.call(e,!1)},this)},_ajax:function(a,b,c){var d;d=window.ActiveXObject?new window.ActiveXObject("Microsoft.XMLHTTP"):new window.XMLHttpRequest;d.open("GET",a);d.onreadystatechange= function(){d.readyState==4&&(d.status==200||d.status==0?b.call(c,d.responseText):b.call(c,!1))};d.send()},ensureLocal:function(a,b,c,d){this._ensureLocal({URLConvertor:this._cfg.URLConvertor,fetcher:this._cfg.fetcher,context:this._cfg.context},a,b,c,function(a){d.call(this._cfg.context,a)},this)},_ensureLocal:function(a,b,c,d,e,f){var c=c?c:[],d=d?d:[],g=0,h=a.URLConvertor?a.URLConvertor:this._cfg.URLConvertor,j=a.context?a.context:this._cfg.context,k=b.length+d.length+c.length;k==0&&e.call(f,!0); for(var i=0;i<b.length;i++){var l=h?h.call(j,b[i]):"";this._fetchTemplate(a,b[i],l,function(a){if(a===!1)throw Error("Failed to fetch template"+l);g++;g==k&&e.call(f,!0)},this)}for(i=0;i<c.length;i++)this._fetchJS(c[i],function(){g++;g==k&&e.call(f,!0)},this);for(i=0;i<d.length;i++)this._fetchCSS(d[i],function(){g++;g==k&&e.call(f,!0)},this)},_fetchJS:function(a,b,c){this._js[a]?b.call(c,!0):this._ajax(a,function(d){if(d===!1)b.call(c,!1);else{var e=document.createElement("script");e.type="text/javascript"; this._isIE()?e.text=d:e.innerHTML=d;document.getElementsByTagName("head")[0].appendChild(e);this._js[a]=!0;b.call(c,!0)}},this)},_ie:null,_isIE:function(){if(this._ie===null)this._ie=navigator.userAgent.indexOf("MSIE")!=-1?!0:!1;return this._ie},_fetchCSS:function(a,b,c){this._css[a]?b.call(c,!0):this._ajax(a,function(d){if(d===!1)b.call(c,!1);else{var e=document.createElement("style");e.type="text/css";this._isIE()?e.styleSheet.cssText=d:e.innerHTML=d;document.getElementsByTagName("head")[0].appendChild(e); this._css[a]=!0;b.call(c,!0)}},this)},_getDependencies:function(a,b,c){b=b?b:{templates:[],js:[],css:[]};c=c?c:{};if(c[a])return b;if(!this._dep[a])return b;c[a]=!0;if(this._dep[a].templates){b.templates=this._uniqueAdd(b.templates,this._dep[a].templates);for(var d=0;d<this._dep[a].templates.length;d++)this._getDependencies(this._dep[a].templates[d],b,c)}if(this._dep[a].js)b.js=this._uniqueAdd(b.js,this._dep[a].js);if(this._dep[a].css)b.css=this._uniqueAdd(b.css,this._dep[a].css);return b},_uniqueAdd:function(a, b){for(var c=[],d={},e=0;e<a.length;e++)c.push(a[e]),d[a[e]]=!0;for(e=0;e<b.length;e++)d[b[e]]||c.push(b[e]);return c},_asynchGenerateHTML:function(a,b){var c=a.context?a.context:this._cfg.context,d=[a.templateName];a.requires&&a.requires instanceof Array&&(d=d.concat(a.requires));a.requires&&a.requires.templates&&(d=d.concat(a.requires.templates));var e=this._getMissingTemplates(d),f=[];if(a.requires&&a.requires.js)f=a.requires.js;var g=[];if(a.requires&&a.requires.css)g=a.requires.css;var h=this._getDependencies(a.templateName), j={};j[a.templateName]=!0;for(var k=0;k<d.length;k++)this._getDependencies(d[k],h,j);e=this._uniqueAdd(e,h.templates);f=this._uniqueAdd(f,h.js);g=this._uniqueAdd(g,h.css);this._ensureLocal(a,e,f,g,function(){var d=this._templates[a.templateName];if(!d.compiled)d.compiled=this._compile(d.raw),delete d.raw;d=this._replaceCompiledTags(d.compiled.chtml,d.compiled.ctags,b);a.ready&&a.ready.call(c,d,a.templateName)},this)},_templates:{},_css:{},_js:{},addTemplates:function(a){for(var b in a){var c=this._compile(a[b]); this._templates[b]={compiled:c}}},addTemplate:function(a,b){if(!this._templates[a]){var c=this._compile(b);this._templates[a]={compiled:c}}},_replaceCompiledTags:function(a,b,c){var d=/_{([\d]+)}_/g,e=/_{[\d]+}_/,f;for(d.lastIndex=0;f=d.exec(a);)a=a.replace(e,this._evalCtag(b,f[1],c)),d.lastIndex=0;return a},_evalCtag:function(a,b,c){b=a[b];switch(b.type){case "code":return this._evalCodeTag(c,b);case "assign":return this._evalCodeTag(c,b,!0);case "if":return this._evalConditionTag(c,a,b);case "loop":return this._evalLoopTag(c, a,b);default:return"Unknown tag"}},_evalLoopTag:function(a,b,c){var d="",e="",f="",g;for(g in this._stack)d+="var "+g+"="+this._stringify(this._stack[g])+";\r\n";f="";for(g in this._stack)f+="this._stack['"+g+"'] = "+g+";\r\n";for(g=0;g<c.vars.length;g++)f+="this._stack['"+c.vars[g]+"'] = "+c.vars[g]+";\r\n";g="var _retVal = '';\r\n"+c.code+"{\r\n\t "+f+"\r\n _retVal += this._replaceCompiledTags('"+c.chtml1.replace(/[\r\n]/g,"")+"',ctags,data);} return _retVal;";try{e=(new Function("data","ctags", "try{"+d+g+"}catch(_err){return _err;}finally{"+f+"}")).call(this,a,b)}catch(h){throw this._log("ERROR: ",h," Fn=_evalLoopTag ctag=",c," data=",a),h;}return e},_log:function(){window.console&&console.log.apply(console,arguments)},_evalConditionTag:function(a,b,c){var d="",e="",f;for(f in this._stack)d+="var "+f+"="+this._stringify(this._stack[f])+";\r\n";var g="";for(f in this._stack)g+="this._stack['"+f+"'] = "+f+";\r\n";for(f=0;f<c.vars.length;f++)g+="this._stack['"+c.vars[f]+"'] = "+c.vars[f]+ ";\r\n";d="try{"+d+("return ("+c.code+");")+"}catch(_err){return _err;}finally{"+g+"}";try{return(e=(new Function("data",d)).call(this,a))?this._replaceCompiledTags(c.chtml1,b,a):this._replaceCompiledTags(c.chtml2,b,a)}catch(h){debugger;this._log("ERROR: ",h," Fn=_evalConditionTag ctag=",c," data=",a);throw h;}},_evalCodeTag:function(a,b,c){var d="",e="",f;for(f in this._stack)d+="var "+f+"="+this._stringify(this._stack[f])+";\r\n";var g="";for(f in this._stack)g+="this._stack['"+f+"'] = "+f+";\r\n"; for(f=0;f<b.vars.length;f++)g+="this._stack['"+b.vars[f]+"'] = "+b.vars[f]+";\r\n";c="try{"+d+((c===!0?"return ":"")+b.code+(c===!0?";":""))+"}catch(_err){return _err;}finally{"+g+" }";try{e=(new Function("data",c)).call(this,a),typeof e==="undefined"&&(e="")}catch(h){throw this._log("ERROR: ",h," Fn=_evalCodeTag ctag=",b," data=",a),h;}return e},_stringify:function(a){if(window.JSON)return JSON.stringify(a);if(typeof a=="string"||typeof a=="number"||typeof a=="boolean")return a.toString();throw Error("Can't stringify an Object or an Array without JSON Support. please include a JSON object to the window object. Try https://github.com/douglascrockford/JSON-js"); },_compile:function(a){for(var b=[],c=0,d={chtml:"",ctags:{}},e,f="chtml",g=null,h="html",j=0,k=a.length;j<k;j++)if(e=a.charAt(j),e=="<"&&j<k-1&&a.charAt(j+1)=="%"){var i=this._getCtagType(a,j+2),g=i;if(i=="code"||i=="assign"||i=="if"||i=="loop"){if(b.length>0)d.ctags[b[b.length-1]]._state=h;e=this._getNewCtag(i);b.push(c);d.ctags[c]=e;this._addToCurrent(f,h,d,"_{"+c+"}_");f=c;c++}h="tag"}else if(h=="tag")if(i=="code"&&e=="%")h="code";else if(i=="assign"&&e=="=")h="code";else if(e==" ")h="code";else{if(e== "%"&&j<k-1&&a.charAt(j+1)==">")g=="else"?h="chtml2":(b.pop(),b.length==0?(g=null,f="chtml",h="html"):(h=d.ctags[b[b.length-1]],g=h.type,f=b[b.length-1],h=h._state)),j++}else if(e=="%"&&j<k-1&&a.charAt(j+1)==">"){if(g=="code"||g=="assign")b.pop(),b.length==0?(g=null,f="chtml",h="html"):(h=d.ctags[b[b.length-1]],g=h.type,f=b[b.length-1],h=h._state);else if(g=="if"||g=="loop")h="chtml1";j++}else h!="tag"&&this._addToCurrent(f,h,d,e);this._findVars(d);return d},_findVars:function(a){for(var b in a.ctags)a.ctags[b].vars= this._findVar(a.ctags[b].code)},_findVar:function(a){for(var b=/var ([^;]*)/g,c,d=[];c=b.exec(a);){c=c[1].replace(/\([^\)]*\)/g,"").split(",");for(var e=0;e<c.length;e++){var f=c[e].split("=")[0],f=f.replace(" ","").replace("\n","").replace("\r","").replace("\t","");d.push(f)}}return d},_addToCurrent:function(a,b,c,d){a=="chtml"?c.chtml+=d:c.ctags[a][b]+=d},_getCtagType:function(a,b){if(a.charAt(b)=="=")return"assign";if(a.charAt(b).toUpperCase()=="I")return"if";if(a.charAt(b).toUpperCase()=="L")return"loop"; if(a.charAt(b).toUpperCase()=="E"&&b<a.length-2){if(a.charAt(b+1).toUpperCase()=="L")return"else";if(a.charAt(b+1).toUpperCase()=="N"&&b<a.length-4){if(a.charAt(b+3).toUpperCase()=="I")return"endif";if(a.charAt(b+3).toUpperCase()=="L")return"endloop"}}return"code"},_getNewCtag:function(a){return{type:a,code:"",chtml1:"",chtml2:"",vars:[]}}};