var BabaJS={_stack:{},generateHTML:function(a,b){this._stack={};if(typeof a==="string"){var c=this._compile(a);return this._replaceCompiledTags(c.chtml,c.ctags,b)}if(!a.ready)if(c=this._templates[a.templateName]){if(!c.compiled)c.compiled=this._compile(c.raw),delete c.raw;return this._replaceCompiledTags(c.compiled.chtml,c.compiled.ctags,b)}else throw Error(a.templateName+" was not found in template manager");this._asynchGenerateHTML(a,b)},_cfg:{fetcher:null,URLConvertor:null,context:window},setConfig:function(a){if(a.URLConvertor)this._cfg.URLConvertor= a.URLConvertor;if(a.fetcher)this._cfg.fetcher=a.fetcher;if(a.context)this._cfg.context=a.context;if(a.dep)this._dep=a.dep;if(a.flagCb)this._cfg.flagCb=a.flagCb},_dep:{},includeTemplate:function(a,b){var c=this._templates[a];if(c){if(!c.compiled)c.compiled=this._compile(c.raw),delete c.raw;return this._replaceCompiledTags(c.compiled.chtml,c.compiled.ctags,b)}throw Error(a+" was not found in template manager");},removeTemplate:function(a){delete this._templates[a]},_getMissingTemplates:function(a){for(var b= [],c=0;c<a.length;c++)this._templates[a[c]]||b.push(a[c]);return b},_fetchTemplate:function(a,b,c,d,e){var f=a.fetcher?a.fetcher:this._cfg.fetcher,a=a.context?a.context:this._cfg.context;if(f){var g=this;f.call(a,b,function(a){g._templates[b]={compiled:g._compile(a)};d.call(e,!0)})}else this._ajax(c,function(a){a!==!1?(this._templates[b]={compiled:this._compile(a)},d.call(e,!0)):d.call(e,!1)},this)},_ajax:function(a,b,c){var d;d=window.ActiveXObject?new window.ActiveXObject("Microsoft.XMLHTTP"):new window.XMLHttpRequest; d.open("GET",a);d.onreadystatechange=function(){d.readyState==4&&(d.status==200||d.status==0?b.call(c,d.responseText):b.call(c,!1))};d.send()},ensureLocal:function(a,b,c,d){this._ensureLocal({URLConvertor:this._cfg.URLConvertor,fetcher:this._cfg.fetcher,context:this._cfg.context},a,b,c,function(a){d.call(this._cfg.context,a)},this)},_ensureLocal:function(a,b,c,d,e,f){var c=c?c:[],d=d?d:[],g=0,k=a.URLConvertor?a.URLConvertor:this._cfg.URLConvertor,l=a.context?a.context:this._cfg.context,h=b.length+ d.length+c.length;h==0&&e.call(f,!0);for(var j=0;j<b.length;j++){var p=k?k.call(l,b[j]):"";this._fetchTemplate(a,b[j],p,function(a){if(a===!1)throw Error("Failed to fetch template"+p);g++;g==h&&e.call(f,!0)},this)}for(j=0;j<c.length;j++)this._fetchJS(c[j],function(){g++;g==h&&e.call(f,!0)},this);for(j=0;j<d.length;j++)this._fetchCSS(d[j],function(){g++;g==h&&e.call(f,!0)},this)},_fetchJS:function(a,b,c){this._js[a]?b.call(c,!0):this._ajax(a,function(d){if(d===!1)b.call(c,!1);else{var e=document.createElement("script"); e.type="text/javascript";this._isIE()?e.text=d:e.innerHTML=d;document.getElementsByTagName("head")[0].appendChild(e);this._js[a]=!0;b.call(c,!0)}},this)},_ie:null,_isIE:function(){if(this._ie===null)this._ie=navigator.userAgent.indexOf("MSIE")!=-1?!0:!1;return this._ie},_fetchCSS:function(a,b,c){this._css[a]?b.call(c,!0):this._ajax(a,function(d){if(d===!1)b.call(c,!1);else{var e=document.createElement("style");e.type="text/css";this._isIE()?e.styleSheet.cssText=d:e.innerHTML=d;document.getElementsByTagName("head")[0].appendChild(e); this._css[a]=!0;b.call(c,!0)}},this)},_getDependencies:function(a,b,c){b=b?b:{templates:[],js:[],css:[]};c=c?c:{};if(c[a])return b;if(!this._dep[a])return b;c[a]=!0;if(this._dep[a].templates){b.templates=this._uniqueAdd(b.templates,this._dep[a].templates);for(var d=0;d<this._dep[a].templates.length;d++)this._getDependencies(this._dep[a].templates[d],b,c)}if(this._dep[a].js)b.js=this._uniqueAdd(b.js,this._dep[a].js);if(this._dep[a].css)b.css=this._uniqueAdd(b.css,this._dep[a].css);return b},_uniqueAdd:function(a, b){for(var c=[],d={},e=0;e<a.length;e++)c.push(a[e]),d[a[e]]=!0;for(e=0;e<b.length;e++)d[b[e]]||c.push(b[e]);return c},_asynchGenerateHTML:function(a,b){var c=a.context?a.context:this._cfg.context,d=[a.templateName];a.requires&&a.requires instanceof Array&&(d=d.concat(a.requires));a.requires&&a.requires.templates&&(d=d.concat(a.requires.templates));var e=this._getMissingTemplates(d),f=[];if(a.requires&&a.requires.js)f=a.requires.js;var g=[];if(a.requires&&a.requires.css)g=a.requires.css;var k=this._getDependencies(a.templateName), l={};l[a.templateName]=!0;for(var h=0;h<d.length;h++)this._getDependencies(d[h],k,l);e=this._uniqueAdd(e,k.templates);f=this._uniqueAdd(f,k.js);g=this._uniqueAdd(g,k.css);this._ensureLocal(a,e,f,g,function(){var d=this._templates[a.templateName];if(!d.compiled)d.compiled=this._compile(d.raw),delete d.raw;d=this._replaceCompiledTags(d.compiled.chtml,d.compiled.ctags,b);a.ready&&a.ready.call(c,d,a.templateName)},this)},_templates:{},_css:{},_js:{},addTemplates:function(a){for(var b in a){var c=this._compile(a[b]); this._templates[b]={compiled:c}}},addTemplate:function(a,b){if(!this._templates[a]){var c=this._compile(b);this._templates[a]={compiled:c}}},_replaceCompiledTags:function(a,b,c){var d=/_{([\d]+)}_/g,e=/_{[\d]+}_/,f;for(d.lastIndex=0;f=d.exec(a);)a=a.replace(e,this._evalCtag(b,f[1],c)),d.lastIndex=0;return a},_evalCtag:function(a,b,c){b=a[b];switch(b.type){case "code":return this._evalCodeTag(c,b);case "assign":return this._evalCodeTag(c,b,!0);case "if":return this._evalConditionTag(c,a,b);case "loop":return this._evalLoopTag(c, a,b);default:return"Unknown tag"}},_evalLoopTag:function(a,b,c){var d="",e="",f="",g;for(g in this._stack)d+="var "+g+"="+this._stringify(this._stack[g])+";\r\n";f="";for(g in this._stack)f+="this._stack['"+g+"'] = "+g+";\r\n";for(g=0;g<c.vars.length;g++)f+="this._stack['"+c.vars[g]+"'] = "+c.vars[g]+";\r\n";g="var _retVal = '';\r\n"+c.code+"{\r\n\t "+f+"\r\n _retVal += this._replaceCompiledTags('"+c.chtml1.replace(/[\r\n]/g,"")+"',ctags,data);} return _retVal;";try{e=(new Function("data","ctags", "try{"+d+g+"}catch(_err){return _err;}finally{"+f+"}")).call(this,a,b)}catch(k){throw this._log("ERROR: ",k," Fn=_evalLoopTag ctag=",c," data=",a),k;}return e},_log:function(){window.console&&console.log.apply(console,arguments)},_evalConditionTag:function(a,b,c){var d="",e="",f;for(f in this._stack)d+="var "+f+"="+this._stringify(this._stack[f])+";\r\n";var g="";for(f in this._stack)g+="this._stack['"+f+"'] = "+f+";\r\n";for(f=0;f<c.vars.length;f++)g+="this._stack['"+c.vars[f]+"'] = "+c.vars[f]+ ";\r\n";d="try{"+d+("return ("+c.code+");")+"}catch(_err){return _err;}finally{"+g+"}";try{return(e=(new Function("data",d)).call(this,a))?this._replaceCompiledTags(c.chtml1,b,a):this._replaceCompiledTags(c.chtml2,b,a)}catch(k){throw this._log("ERROR: ",k," Fn=_evalConditionTag ctag=",c," data=",a),k;}},_evalCodeTag:function(a,b,c){var d="",e="",f;for(f in this._stack)d+="var "+f+"="+this._stringify(this._stack[f])+";\r\n";var g="";for(f in this._stack)g+="this._stack['"+f+"'] = "+f+";\r\n";for(f= 0;f<b.vars.length;f++)g+="this._stack['"+b.vars[f]+"'] = "+b.vars[f]+";\r\n";c="try{"+d+((c===!0?"return ":"")+b.code+(c===!0?";":""))+"}catch(_err){return _err;}finally{"+g+" }";try{e=(new Function("data",c)).call(this,a),typeof e==="undefined"&&(e="")}catch(k){throw this._log("ERROR: ",k," Fn=_evalCodeTag ctag=",b," data=",a),k;}b.flags.length&&(this._cfg.flagCb?(a=this._cfg.flagCb.call(this._cfg.context,e,b.flags),e=typeof a=="string"?a:this._processPredefinedFlags(b.flags,e)):e=this._processPredefinedFlags(b.flags, e));return e},_processPredefinedFlags:function(a,b){if(a[0]=="s")return this._secureText(b,"low");if(a[0]=="S")return this._secureText(b,"high");return b},secureText:function(a,b){return this._secureText(a,typeof b=="undefined"?"low":b)},_secureText:function(a,b){if(!a)return a;var c=this;return a.replace({low:/[\<\>\"\']/g,high:/[\<\>\&\"\'\`\,\!\@\$\%\(\)\[\]\{\}\=\+]/g}[b],function(a){return c._escaped[a]})},_escaped:{"'":"&lsquo;","<":"&lt;",">":"&gt;","&":"&amp;",'"':"&quot;","`":"&#96;",",":"&#44;","!":"&#33;", "@":"&#64;",$:"&#36;","(":"&#40;",")":"&#41;","[":"&#91;","]":"&#93;","{":"&#123;","}":"&#125;","=":"&#61;","+":"&#61;"},_stringify:function(a){if(window.JSON)return JSON.stringify(a);if(typeof a=="string"||typeof a=="number"||typeof a=="boolean")return a.toString();throw Error("Can't stringify an Object or an Array without JSON Support. please include a JSON object to the window object. Try https://github.com/douglascrockford/JSON-js");},_compile:function(a){for(var b=[],c=0,d={chtml:"",ctags:{}}, e,f="",g=null,k="chtml",l=null,h="html",j=0,p=a.length;j<p;j++)if(e=a.charAt(j),e=="<"&&j<p-1&&a.charAt(j+1)=="%"){var n=this._getCtagType(a,j+2),l=n;if(n=="code"||n=="assign"||n=="if"||n=="loop"){if(b.length>0)d.ctags[b[b.length-1]]._state=h;var o=this._getNewCtag(n);b.push(c);d.ctags[c]=o;this._addToCurrent(k,h,d,"_{"+c+"}_");k=c;c++}h="tag"}else if(h=="flag")if(e!=","&&e!=" "&&e!='"'&&e!="'"&&e!=")")f+=e,e=="."&&g=="number"?g="float":e>="0"&&e<="9"&&g!=="string"&&g!=="float"&&(g="number");else if(e== ","||e==" ")f.length&&(e=f,g=="number"&&(e=parseInt(f)),g=="float"&&(e=parseFloat(f)),o.flags.push(e)),f="",g=null;else{if(e==")"&&(f.length&&(e=f,g=="number"&&(e=parseInt(f)),g=="float"&&(e=parseFloat(f)),o.flags.push(e)),f="",g=null,a.charAt(j+1)==" "||a.charAt(j+1)=="=")){h="code";if(a.charAt(j+1)=="=")n=o.type="assign";j++}}else if(h=="tag")if((n=="code"||n=="assign")&&e=="%"&&a.charAt(j+1)=="f")h="flag",j+=2,f="",g=null;else if(n=="code"&&e=="%"&&a.charAt(j+1).toLowerCase()!="s"&&a.charAt(j+ 1)!="f")h="code";else if(n=="assign"&&e=="=")h="code";else if(e==" ")h="code";else{if(e=="%"&&j<p-1&&a.charAt(j+1)==">")l=="else"?h="chtml2":(b.pop(),b.length==0?(l=null,k="chtml",h="html"):(h=d.ctags[b[b.length-1]],l=h.type,k=b[b.length-1],h=h._state)),j++}else if(e=="%"&&j<p-1&&a.charAt(j+1)==">"){if(l=="code"||l=="assign")b.pop(),b.length==0?(l=null,k="chtml",h="html"):(h=d.ctags[b[b.length-1]],l=h.type,k=b[b.length-1],h=h._state);else if(l=="if"||l=="loop")h="chtml1";j++}else h!="tag"&&this._addToCurrent(k, h,d,e);this._findVars(d);return d},_findVars:function(a){for(var b in a.ctags)a.ctags[b].vars=this._findVar(a.ctags[b].code)},_isWhiteSpace:function(a){return/[\s]/.test(a)},_findVar:function(a){for(var b=[],c=!1,d="",e=0,f=0,g=0,k=0,l=0,h=!1,j=!1,p=0,n=0,o=!1,q=!1,i=0,r=a.length;i<r;i++){var m=a.charAt(i);if(m=="("){if(e++,!h&&i>=8&&a.charAt(i-1)=="n"&&a.charAt(i-2)=="o"&&a.charAt(i-3)=="i"&&a.charAt(i-4)=="t"&&a.charAt(i-5)=="c"&&a.charAt(i-6)=="n"&&a.charAt(i-7)=="u"&&a.charAt(i-8)=="f"&&(h=!0), !q&&!h&&!o&&(i>=3&&a.charAt(i-1)=="r"&&a.charAt(i-2)=="o"&&a.charAt(i-3)=="f"||i>=5&&a.charAt(i-1)=="e"&&a.charAt(i-2)=="l"&&a.charAt(i-3)=="i"&&a.charAt(i-4)=="h"&&a.charAt(i-5)=="w"))q=!0}else if(m==")")e--,e==0&&!h&&!j&&q&&(q=!1),h&&f==0&&e==0&&(h=!1);else if(m=="{")f++,o&&g++;else if(m=="[")l++,o&&k++;else if(m=="]")l--,o&&k--;else if(m=="}")f--,o&&g--,h&&f==0&&e==0&&(h=!1);else if(m=='"')p=p?0:1;else if(m=="'")n=n?0:1;else if(m=="="&&!h&&c&&!j){o=!0;d&&(b.push(d),d="");continue}j=n||p?!0:!1; if(!h&&!j&&(q||!e))if(!c&&m=="v"){if(i==0&&i<r-4&&a.charAt(i+1)=="a"&&a.charAt(i+2)=="r"&&this._isWhiteSpace(a.charAt(i+3))||(this._isWhiteSpace(a.charAt(i-1))||a.charAt(i-1)=="{"||a.charAt(i-1)=="(")&&i<r-4&&a.charAt(i+1)=="a"&&a.charAt(i+2)=="r"&&this._isWhiteSpace(a.charAt(i+3)))c=!0,i+=3}else c&&(m==","&&g==0&&k==0?(d&&(b.push(d),d=""),o=!1):m==" "&&q?(d&&(b.push(d),d=""),i<r-3&&a.charAt(i+1)=="i"&&a.charAt(i+2)=="n"&&a.charAt(i+3)==" "&&(o=c=!1)):m==";"?(d&&(b.push(d),d=""),o=c=!1):m=="i"&&i< r-3&&a.charAt(i+1)=="n"&&this._isWhiteSpace(a.charAt(i+2))?(d&&(b.push(d),d=""),c=!1):!this._isWhiteSpace(m)&&!o&&(d+=m))}return b},_addToCurrent:function(a,b,c,d){a=="chtml"?c.chtml+=d:c.ctags[a][b]+=d},_getCtagType:function(a,b){if(a.charAt(b)=="=")return"assign";if(a.charAt(b).toUpperCase()=="I")return"if";if(a.charAt(b).toUpperCase()=="L")return"loop";if(a.charAt(b).toUpperCase()=="E"&&b<a.length-2){if(a.charAt(b+1).toUpperCase()=="L")return"else";if(a.charAt(b+1).toUpperCase()=="N"&&b<a.length- 4){if(a.charAt(b+3).toUpperCase()=="I")return"endif";if(a.charAt(b+3).toUpperCase()=="L")return"endloop"}}return"code"},_getNewCtag:function(a){return{type:a,code:"",chtml1:"",chtml2:"",vars:[],flags:[]}}};